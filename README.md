# 포인트 관리 시스템
이 프로젝트는 TDD 기반의 포인트 관리 서비스입니다. <br/> 사용자의 포인트 충전, 사용, 조회 기능을 제공하며 동시성 제어를 통해 멀티 스레드 환경에서 데이터 무결성을 보장합니다.

---

## 1. 요구사항
### 1.1 포인트 조회
- 기존 사용자 포인트 정보 조회
- 조회한 id의 사용자가 등록되어 있지 않은 경우 사용자 신규 생성

### 1.2 포인트 내역 조회
- 사용자의 포인트 내역 조회
- 등록되지 않은 사용자는 빈 리스트 반환

### 1.3 포인트 충전
- 포인트 충전
    - 0원 초과 금액만 충전 가능
    - 최대 잔고 100만원: 충전 요청시 합산 금액이 100만원 초과되는 경우 포인트 충전 불가
- 포인트 이력 적재

### 1.4 포인트 사용
- 포인트 사용
    - 0원 초과 금액만 사용 가능
    - 잔고 부족: 사용 요청 금액이 잔고를 초과할 경우 포인트 사용 불가
- 포인트 이력 적재

### 1.5 동시성 제어
- 동일 사용자에 대한 포인트 변경(사용, 충전) 요청시 순차적으로 처리

## 2. 동시성 제어 설계
선택한 언어에 대한 동시성 제어 방식 및 각 적용의 장/단점을 기술한 보고서 작성

### 2.1 동시성 이슈 개요
- 멀티스레드 환경에서 동일한 자원에 여러 스레드가 동시에 접근하면 **경합(Race Condition)**이 발생할 수 있으며, 이로 인해 데이터 손상, 정합성 오류, 예측 불가능한 동작이 유발된다.<br/> 특히 포인트 누적(사용, 충전)과 같이 순차적이고 정확한 연산이 필요한 경우, 동시성 제어는 데이터 무결성을 위해 꼭 필요한 안정성 요건이다.

### 2.2 Java의 주요 동시성 제어 방식
#### 2.2.2 synchronized 키워드
- 장점: 사용법이 간단, JVM 레벨에서 관리됨
- 단점: 재진입 제어나 조건 대기/알림 같은 정교한 제어가 어려움<br/> 특정 객체 단위로 락이 고정되고, 락 해제가 자동이기 때문에 범위를 컨트롤 할 수 없어 유연성 저하.

#### 2.2.3 ✅ ReentrantLock
- 장점: tryLock(), lockInterruptibly(), Condition 등 세밀한 제어 가능, 재진입 가능 (같은 스레드가 여러 번 lock 걸 수 있음)
- 단점: 반드시 unlock()을 명시적으로 호출해야 하며, 실수하면 데드락 발생 위험
- 적용대상: 특정 구간에 대한 통제가 필요한 경우

#### 2.2.4 ✅ ConcurrentHashMap
- 장점: 다중 스레드가 동시에 읽고 쓸 수 있도록 세그먼트 락 구조 제공, 일반 HashMap보다 동시성 성능이 훨씬 뛰어남
- 단점: 복잡한 트랜잭션 또는 원자적 복합 연산에는 부족
- 적용대상: 캐시, 단일 객체 저장소, 단순 key-value 형태 저장소

#### 2.2.5 AtomicInteger, AtomicLong
- 장점: lock-free한 원자 연산이 가능하여 성능 우수, 단순 수치 연산에 적합(e.g. 충전/사용)
- 단점: 상태가 복잡해지면 적용 어려움 (e.g. 포인트에 내역 기록 등)
- 적용대상: 단일 정수 상태의 변경이 필요한 상황

#### 2.2.6 DB Lock (Pessimistic, Optimistic)
- 비관적 락(Pessimistic)
    - SELECT FOR UPDATE와 같이 DB에서 락을 걸어 충돌 회피
    - 정확하지만 성능 저하 가능성 있음
- 낙관적 락(Optimistic)
    - 버전 필드(version)를 활용한 충돌 감지 → 실패 시 재시도
    - 동시 쓰기 성능은 좋지만 충돌 발생 시 롤백/재시도 비용 있음
    - 적용대상: 복수 서버 환경에서 DB가 공유되고, DB가 최종 일관성을 책임지는 구조

### 2.3  본 시스템에서 채택한 방식
#### 2.3.1 ConcurrentHashMap
- 포인트를 메모리 기반 저장소에 저장하며, 스레드 간 안전한 키-값 접근 보장한다.
- 단일 사용자 포인트 정보 조회 및 업데이트에 사용된다.

#### 2.3.2 ReentrantLock
- 포인트 충전 및 사용 로직에만 명시적으로 Lock을 적용하여 유연하게 사용 가능함
- 동시 충전 또는 동시 사용 요청이 들어올 경우에도 순차적으로 하나의 스레드만 처리되도록 보장한다.
